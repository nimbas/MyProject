<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.acube.sub.repository.CounselRepository">
	
	<sql id="whereCounselList">
    	WHERE counsel.cust_no = #{filterMap.custNo}
        order by counsel.sys_create_date desc  	
    </sql>
	
	<select id="getCounselList" parameterType="AsSearchFilter" resultType="AsCounsel">
		SELECT
        		counsel.counsel_id AS   counselId       ,
        		counsel.market_code         AS   marketCode      ,
        		(select entr_no from aba_ccm_entr_counsel where  counsel_id=counsel.counsel_id and rownum=1) entrNo,
        		(select svc_cd from aba_sb_entr a, aba_ccm_entr_counsel b where a.entr_no=b.entr_no and b.counsel_id=counsel.counsel_id and rownum=1) svcCd,
        		counsel.cust_no             AS   custNo          ,
        		counsel.cust_type            AS   custType          ,
        		counsel.service_type         AS   serviceType          ,
        		counsel.counsel_name        AS   counselName     ,
        		counsel.counsel_name2        AS   counselName2     ,
        		counsel.counsel_name3        AS   counselName3     ,
        		counsel.counsel_tel         AS   counselTel      ,
        		counsel.cust_req            AS   custReq         ,
				counsel.counsel_res         AS   counselRes      ,
				counsel.relationship_type   AS   relationshipType,
				counsel.reg_date            AS   regDate,   
				counsel.counsel_division    AS   counselDivision ,
				counsel.counsel_type_cd     AS   counselTypeCd   ,
				counsel.counsel_dtl_cd      AS   counselDtlCd    ,
				counsel.counsel_dtl_cd2      AS   counselDtlCd2    ,
				counsel.counsel_dtl_cd3      AS   counselDtlCd3    ,
				counsel.counsel_dtl_cd4      AS   counselDtlCd4    ,
				counsel.counsel_dtl_cd5      AS   counselDtlCd5    ,
				counsel.counsel_dtl_cd6      AS   counselDtlCd6    ,
				counsel.counsel_dtl_cd7      AS   counselDtlCd7    ,
				counsel.counsel_dtl_cd8      AS   counselDtlCd8    ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_division and rownum=1)    AS   counselDivisionText ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_type_cd and rownum=1)     AS   counselTypeCdText   ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_dtl_cd and rownum=1)      AS   counselDtlCdText    ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_dtl_cd2 and rownum=1)      AS   counselDtlCd2Text    ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_dtl_cd3 and rownum=1)      AS   counselDtlCd3Text    ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_dtl_cd4 and rownum=1)      AS   counselDtlCd4Text    ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_dtl_cd5 and rownum=1)      AS   counselDtlCd5Text    ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_dtl_cd6 and rownum=1)      AS   counselDtlCd6Text    ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_dtl_cd7 and rownum=1)      AS   counselDtlCd7Text    ,
				(SELECT activity_desc from aba_ccm_activity a WHERE a.activity_code=counsel.counsel_dtl_cd8 and rownum=1)      AS   counselDtlCd8Text    ,
                (SELECT activity_desc from aba_ccm_activity a WHERE a.activity_seqno = counsel.activity_seqno and rownum=1) AS activityDesc,
				counsel.activity_cd         AS   activityCd      ,
				counsel.transfer_type       AS   transferType    ,
				counsel.transfer_text       AS   transferText    ,
				counsel.counsel_status      AS   counselStatus   ,
				decode(counsel.counsel_status,'T','Accept','R','Progress','C','Complete') AS counselStatusText,
				counsel.first_operator      AS   firstOperator   ,
				counsel.hope_date           AS   hopeDate        ,
				counsel.hope_time           AS   hopeTime        ,
				counsel.rsv_date8           AS   rsvDate8        ,
				counsel.rsv_time            AS   rsvTime         ,
				counsel.counsel_end_date8   AS   counselEndDate8 ,
				counsel.counsel_end_time    AS   counselEndTime ,
				(select order_num from aba_ccm_order where counsel_id = counsel.counsel_id and rownum=1) orderNum,
				counsel.as_type    AS   asType,
				counsel.add_num AS addNum,
				counsel.cust_vilg_above_addr  AS custVilgAbvAddr,
				counsel.cust_vilg_below_addr  AS custVilgBlwAddr,
				counsel.door_code AS doorCode,
				counsel.activity_seqno       AS  activitySeqNo,
				occurrence_date     AS occurrenceDate,
				occurrence_time  AS occurrenceTime,
				satisfaction_yn AS satisfactionYn,
				satisfaction_que_seq AS satisfactionQueSeq,
				satisfaction_ans_seq AS satisfactionAnsSeq,
				counsel.mdu_ip AS mduIp,
				counsel.mdu_port AS mduPort,
				counsel.softphone_check AS softPhoneCheck  
        FROM 	aba_ccm_counsel_info counsel        		
        <include refid="whereCounselList"/>      
	</select>
	
	<insert id="addCounselInfo" parameterType="AsCounsel">
		INSERT INTO aba_ccm_counsel_info ( 
				counsel_id, 
				market_code,  
				cust_no, 
				counsel_owner,
	     		counsel_name, 
	     		counsel_tel, 
	     		cust_req, 
	     		counsel_res, 
	     		relationship_type,
				reg_date, 
				counsel_division, 
				counsel_type_cd, 
				counsel_dtl_cd, 
				counsel_dtl_cd2, 
				counsel_dtl_cd3, 
				counsel_dtl_cd4, 
				counsel_dtl_cd5,
				counsel_dtl_cd6, c
				ounsel_dtl_cd7, 
				counsel_dtl_cd8, 
				activity_cd,
				transfer_type, 
				transfer_text, 
				counsel_status, 
				first_operator, 
				hope_date,
				hope_time, 
				rsv_date8, 
				rsv_time, 
				counsel_end_date8, 
				counsel_end_time,
				sys_create_date,
				sys_update_date,
				sys_operator_id,
				sys_application_id,
				dl_service_code,
				dl_update_stamp,
				counsel_name2,
				counsel_name3,
				cust_type,
				service_type, 
				add_num,
				cust_vilg_above_addr,
				cust_vilg_below_addr,
				as_type,
				activity_seqno,
				occurrence_date,
				occurrence_time ,
				door_code,
				mdu_ip,
				mdu_port,
				softphone_check)
		VALUES ( 
								
				#{counselId},
				#{operator.branch.marketCode},
				#{custNo,jdbcType=VARCHAR},
				#{operator.userId},
				#{counselName,jdbcType=VARCHAR},
				#{counselTel,jdbcType=VARCHAR},
				#{custReq,jdbcType=VARCHAR},
				#{counselRes,jdbcType=VARCHAR},
				#{relationshipType,jdbcType=VARCHAR},
				sysdate, 
				#{counselDivision ,jdbcType=VARCHAR},
				#{counselTypeCd ,jdbcType=VARCHAR},
				#{counselDtlCd ,jdbcType=VARCHAR},
				#{counselDtlCd2 ,jdbcType=VARCHAR},
				#{counselDtlCd3 ,jdbcType=VARCHAR},
				#{counselDtlCd4 ,jdbcType=VARCHAR},
				#{counselDtlCd5 ,jdbcType=VARCHAR},
				#{counselDtlCd6 ,jdbcType=VARCHAR},
				#{counselDtlCd7 ,jdbcType=VARCHAR},
				#{counselDtlCd8 ,jdbcType=VARCHAR},
				#{actMode,jdbcType=VARCHAR},
				#{transferType,jdbcType=VARCHAR},
				#{transferText,jdbcType=VARCHAR},
				#{counselStatus},
				#{operator.userId},
				#{hopeDate},
				#{hopeTime,jdbcType=VARCHAR},
				#{rsvDate8,jdbcType=VARCHAR},
				#{rsvTime,jdbcType=VARCHAR},
		         <choose>
		         <when test='counselStatus eq "C"'>
		         to_char(sysdate,'yyyymmdd'),
		         to_char(sysdate,'hh24miss'),
		         </when>
		         <otherwise>
		         #{counselEndDate8,jdbcType=VARCHAR}, 
		         #{counselEndTime,jdbcType=VARCHAR},
		         </otherwise>
		         </choose>
		         sysdate, 
				 sysdate,
				 #{operator.userId},
				 #{applicationId},
				 '',
				 0 , 
				 #{counselName2,jdbcType=VARCHAR},
				 #{counselName3,jdbcType=VARCHAR},
				 #{custType},
				 #{serviceType,jdbcType=VARCHAR},
				 #{addNum,jdbcType=VARCHAR},
				 #{custVilgAbvAddr,jdbcType=VARCHAR},
				 #{custVilgBlwAddr,jdbcType=VARCHAR},
				 #{asType,jdbcType=VARCHAR},
				 #{activitySeqNo,jdbcType=VARCHAR},
				 #{occurrenceDate,jdbcType=VARCHAR},
				 #{occurrenceTime,jdbcType=VARCHAR},
				 #{doorCode,jdbcType=VARCHAR},
				 #{mduIp,jdbcType=VARCHAR},
				 #{mduPort,jdbcType=VARCHAR},
				 #{softPhoneCheck,jdbcType=VARCHAR} )
	</insert>
	
	<insert id="addCounselCustInfo" parameterType="AsCounsel">
		INSERT INTO aba_ccm_counsel_cust_info ( counsel_id , service_type, sys_create_date, sys_update_date, sys_operator_id, 
		                                        sys_application_id, dl_service_code, dl_update_stamp, addnum, cust_vilg_abv_addr, cust_vilg_blw_addr, door_code, mdu_ip, mdu_port , softphone_check)
		                          	   VALUES ( #{counselId}, #{serviceType,jdbcType=VARCHAR},sysdate, sysdate, #{operator.userId}, 
		                                        #{applicationId},'',0 , #{addNum,jdbcType=VARCHAR}, #{custVilgAbvAddr,jdbcType=VARCHAR}, #{custVilgBlwAddr,jdbcType=VARCHAR}, #{doorCode,jdbcType=VARCHAR},#{mduIp,jdbcType=VARCHAR},#{mduPort,jdbcType=VARCHAR},#{softPhoneCheck,jdbcType=VARCHAR}	 )
	</insert>

</mapper>